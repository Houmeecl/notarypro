import{u as H,r as l,j as e,bh as V,bc as R,a as v,bm as ee,W as ae,bE as se,bH as re,bI as te,bJ as ie,L as oe,U as O,bK as ne,p as ce,y as S,aB as le,d as A,v as T,x as D,z as L,e as F,aW as de,V as U,ay as me,P as ue,i as xe}from"./index-BPC64rrb.js";import{F as K}from"./ForcedModeNotification-DitjzG4k.js";async function fe(a={}){const o=a.timeout||1e4,s=a.retries||3;let i=null,n=0;const g=[{video:a.video||!0,audio:a.audio||!1},{video:!0,audio:a.audio||!1},{video:{width:{ideal:640},height:{ideal:480},frameRate:{max:15}},audio:a.audio||!1},{video:{facingMode:"user"},audio:a.audio||!1},{video:{width:{ideal:320},height:{ideal:240}},audio:a.audio||!1}];for(;n<s;){const p=Math.min(n,g.length-1),d=g[p];try{console.log(`Intento ${n+1}/${s} con configuración:`,d);const c=navigator.mediaDevices.getUserMedia(d),m=new Promise((h,u)=>{setTimeout(()=>u(new Error("Timeout al acceder a la cámara")),o)}),j=await Promise.race([c,m]);return console.log("Cámara inicializada correctamente con configuración:",d),j}catch(c){i=c,console.error(`Error en intento ${n+1}:`,c),n++}}throw new Error(`No se pudo acceder a la cámara después de ${s} intentos: ${(i==null?void 0:i.message)||"Error desconocido"}`)}function G(a){if(!a)return"Error desconocido al acceder a la cámara. Debido a que estamos en MODO FORZADO, puede continuar con la sesión sin cámara.";console.error("Diagnóstico detallado de error de cámara:",{name:a.name,message:a.message,stack:a.stack,error:JSON.stringify(a,Object.getOwnPropertyNames(a))});const o=a.name||"",s=a.message||"",i="Debido a que estamos en MODO FORZADO, puede continuar con la sesión sin necesidad de cámara.";return o==="NotFoundError"||s.includes("not found")||s.includes("no encontr")?`No se detectó ninguna cámara. Verifique que su dispositivo tenga una cámara conectada y funcionando correctamente. ${i}`:o==="NotAllowedError"||o==="PermissionDeniedError"||s.includes("permission")||s.includes("permiso")?`Permiso denegado para acceder a la cámara. Por favor, permita el acceso a la cámara cuando el navegador lo solicite. ${i}`:o==="NotReadableError"||o==="TrackStartError"||s.includes("hardware")||s.includes("in use")||s.includes("en uso")?`No se puede acceder a la cámara. Puede que esté siendo utilizada por otra aplicación. Cierre otras aplicaciones que puedan estar usando la cámara e intente nuevamente. ${i}`:o==="OverconstrainedError"||s.includes("constraint")||s.includes("restricci")?`Las restricciones de video solicitadas no pueden ser satisfechas por su cámara. Intente con una configuración de menor calidad. ${i}`:o==="SecurityError"?`Su navegador ha bloqueado el acceso a la cámara por razones de seguridad. Intente usar HTTPS o un navegador diferente. ${i}`:o==="AbortError"||s.includes("abort")||s.includes("abort")?`La operación fue cancelada. Esto puede ocurrir si cambió de pestaña durante el proceso de autorización. ${i}`:o==="TypeError"||s.includes("type")?`Error de configuración al acceder a la cámara. Intente con un navegador diferente como Chrome o Firefox. ${i}`:o===""&&s===""&&!a.name&&!a.message?`No se pudo acceder a la cámara o micrófono. Es posible que no haya concedido permisos o que otro programa esté usando los dispositivos. ${i}`:`Error al acceder a la cámara: ${s||o||"Error desconocido"}. ${i}`}const he=({sessionId:a,role:o,onSessionEnd:s,onVerificationComplete:i})=>{const{toast:n}=H(),g=l.useRef(null),p=l.useRef(null),d=l.useRef(null),c=l.useRef([]),[m,j]=l.useState(!1),[h,u]=l.useState(!0),[y,C]=l.useState(!1),[N,x]=l.useState(null),[E,Z]=l.useState(!0),[k,Y]=l.useState(!0);l.useEffect(()=>((()=>{if(window.AgoraRTC){console.log("Agora SDK ya está cargado"),C(!0);return}const r=document.createElement("script");r.src="https://download.agora.io/sdk/release/AgoraRTC_N.js",r.async=!0,r.onload=()=>{console.log("Agora SDK cargado correctamente"),C(!0)},r.onerror=()=>{console.error("Error al cargar Agora SDK"),x("No se pudo cargar la biblioteca de videollamadas. Intente recargar la página o use un navegador diferente como Chrome o Firefox.")},document.body.appendChild(r)})(),()=>{P()}),[]),l.useEffect(()=>{y&&!m&&!N&&M()},[y]);const B=async(t,r)=>{var b;await((b=d.current)==null?void 0:b.subscribe(t,r)),r==="video"&&p.current&&t.videoTrack.play(p.current),r==="audio"&&t.audioTrack.play()},_=(t,r)=>{console.log("Usuario dejó de publicar:",t.uid,r)},J=async()=>{try{return(await fe({video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:!0,retries:3})).getTracks().forEach(r=>r.stop()),!0}catch(t){const r=G(t);return x(r),console.error("Error al solicitar acceso a dispositivos:",t),!1}},M=async()=>{u(!0);try{if(console.log("RON iniciado en modo producción"),console.log("Solicitando acceso a cámara/micrófono con config:",{video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:!0}),!await J()){u(!1);return}let r;try{const f=await fetch(`/api/ron/public/session/${a}/tokens`,{method:"GET",headers:{"Content-Type":"application/json"}});if(f.ok)r=await f.json();else{const w=await fetch(`/api/ron/session/${a}/video-tokens`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!w.ok)throw new Error("No se pudieron obtener credenciales para la videollamada");r=await w.json()}}catch(f){console.error("Error al obtener tokens:",f),r={appId:"43b48ab9fbc942b3bb52c17cad38e08b",channelName:`ron-session-${a.replace("RON-","")}`,token:null,uid:o==="certifier"?1:2},console.log("Usando configuración de video alternativa (modo forzado)")}const b=window.AgoraRTC.createClient({mode:"rtc",codec:"vp8"});d.current=b,b.on("user-published",B),b.on("user-unpublished",_);const{appId:X,channelName:$,token:I}=r,z=o==="certifier"?1:2;console.log("Conectando a Agora con:",{channelName:$,userId:z,withToken:!!I}),await b.join(X,$,I||null,z);try{console.log("Creando tracks de audio/video");const f=await window.AgoraRTC.createMicrophoneAndCameraTracks({audioConfig:{AEC:!0,AGC:!0,ANS:!0,microphoneId:void 0},videoConfig:{encoderConfig:"high_quality",facingMode:"user",mirrorMode:"auto"}});c.current=f;const w=f[0],q=f[1];g.current&&(console.log("Reproduciendo video local"),q.play(g.current)),console.log("Publicando tracks en canal"),await b.publish([w,q]),j(!0),u(!1),n({title:"Conectado a la sesión",description:"Sesión RON iniciada correctamente"})}catch(f){console.error("Error al crear o publicar tracks:",f);const w=G(f);x(w),await b.leave(),d.current=null,u(!1)}}catch(t){console.error("Error al unirse a la sesión RON:",t),x(t.message||"Hubo un problema al conectar a la sesión"),u(!1),n({title:"Error al conectar",description:t.message||"Hubo un problema al conectar a la sesión",variant:"destructive"})}},P=async()=>{var t;try{c.current.length>0&&(c.current.forEach(r=>{r.stop(),r.close()}),c.current=[]),await((t=d.current)==null?void 0:t.leave()),d.current=null,j(!1),console.log("Sesión finalizada, todos los recursos liberados"),s&&s()}catch(r){console.error("Error al salir de la sesión:",r)}},W=async()=>{if(c.current.length>=1){const t=c.current[0];E?await t.setEnabled(!1):await t.setEnabled(!0),Z(!E)}},Q=async()=>{if(c.current.length>=2){const t=c.current[1];k?await t.setEnabled(!1):await t.setEnabled(!0),Y(!k)}};return N?e.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center bg-slate-900 text-white p-6",children:e.jsxs("div",{className:"max-w-md text-center bg-slate-800 p-8 rounded-lg shadow-lg border border-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-4",children:[e.jsx(V,{className:"h-10 w-10 text-yellow-400"}),e.jsx(R,{className:"h-10 w-10 text-indigo-400"})]}),e.jsxs("div",{className:"mb-2 inline-flex items-center justify-center px-3 py-1 rounded-full bg-indigo-900 text-indigo-100",children:[e.jsx(R,{className:"h-4 w-4 mr-1.5"}),"MODO FORZADO ACTIVO"]}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Error de acceso a dispositivos"}),e.jsx("p",{className:"text-slate-300 mb-6",children:N}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(v,{variant:"outline",className:"w-full bg-indigo-700 text-white hover:bg-indigo-800",onClick:()=>{j(!0),u(!1),x(null),n({title:"MODO FORZADO activado",description:"Continuando sesión en modo forzado sin video"})},children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Continuar en MODO FORZADO sin cámara"]}),e.jsxs(v,{variant:"default",className:"w-full",onClick:()=>{x(null),M()},children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Reintentar acceso a cámara"]}),e.jsx(v,{variant:"outline",className:"w-full",onClick:()=>{s?s():window.location.href="/ron-platform"},children:"Cancelar y volver"})]}),e.jsxs("div",{className:"mt-6 text-slate-400 text-sm",children:[e.jsx("p",{className:"mb-2",children:"Consejos para solucionar problemas:"}),e.jsxs("ul",{className:"text-left list-disc pl-5",children:[e.jsx("li",{children:"Asegúrese de que su cámara no esté siendo usada por otra aplicación"}),e.jsx("li",{children:"Permita acceso a la cámara cuando el navegador lo solicite"}),e.jsx("li",{children:"Pruebe con un navegador diferente (Chrome o Firefox)"}),e.jsx("li",{children:"Reinicie su computadora si el problema persiste"})]}),e.jsxs("div",{className:"mt-4 p-3 bg-slate-700 rounded-md",children:[e.jsx("p",{className:"font-medium text-indigo-300",children:"Acerca del MODO FORZADO:"}),e.jsx("p",{className:"mt-1",children:"Este modo permite continuar con la verificación incluso si hay problemas técnicos, garantizando compatibilidad con la Ley 19.799."})]})]})]})}):e.jsxs("div",{className:"relative w-full h-full min-h-[500px] flex flex-col bg-slate-900 text-white",children:[e.jsxs("div",{className:"bg-slate-800 p-4 shadow-md flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-5 w-5 text-indigo-400 mr-2"}),e.jsxs("h2",{className:"text-lg font-semibold",children:["Sesión RON: ",a]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{size:"sm",variant:k?"default":"destructive",onClick:Q,disabled:!m||h,children:k?e.jsx(se,{className:"h-4 w-4"}):e.jsx(re,{className:"h-4 w-4"})}),e.jsx(v,{size:"sm",variant:E?"default":"destructive",onClick:W,disabled:!m||h,children:E?e.jsx(te,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs(v,{size:"sm",variant:"destructive",onClick:P,disabled:!m||h,children:[e.jsx(oe,{className:"h-4 w-4 mr-1"})," Salir"]})]})]}),h&&e.jsxs("div",{className:"absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center z-20",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"}),e.jsx("p",{className:"text-indigo-300",children:"Conectando a la sesión RON..."}),e.jsx("p",{className:"text-sm text-slate-400 mt-2",children:"Espere mientras se establece la conexión."})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 p-4",children:[e.jsxs("div",{className:"relative bg-slate-800 rounded-lg overflow-hidden shadow-md border border-slate-700 flex flex-col",children:[e.jsxs("div",{className:"p-2 bg-slate-700 flex items-center",children:[e.jsx(O,{className:"h-4 w-4 text-indigo-300 mr-2"}),e.jsx("span",{className:"text-sm font-medium",children:o==="certifier"?"Certificador":"Mi cámara"})]}),e.jsx("div",{ref:g,className:"flex-1 bg-slate-900 flex items-center justify-center",children:!m&&!h&&e.jsxs("div",{className:"text-center p-4",children:[e.jsx(V,{className:"h-12 w-12 mx-auto mb-2 text-slate-600"}),e.jsx("p",{className:"text-slate-400",children:"Esperando conexión de video..."})]})})]}),e.jsxs("div",{className:"relative bg-slate-800 rounded-lg overflow-hidden shadow-md border border-slate-700 flex flex-col",children:[e.jsxs("div",{className:"p-2 bg-slate-700 flex items-center",children:[e.jsx(O,{className:"h-4 w-4 text-indigo-300 mr-2"}),e.jsx("span",{className:"text-sm font-medium",children:o==="certifier"?"Cliente":"Certificador"})]}),e.jsx("div",{ref:p,className:"flex-1 bg-slate-900 flex items-center justify-center",children:!m&&!h&&e.jsxs("div",{className:"text-center p-4",children:[e.jsx(O,{className:"h-12 w-12 mx-auto mb-2 text-slate-600"}),e.jsx("p",{className:"text-slate-400",children:"Esperando que el otro participante se conecte..."})]})})]})]})]})};function je(){const a=ne(),[o,s]=ce(),{toast:i}=H(),[n,g]=l.useState(a.code||""),[p,d]=l.useState(!1),[c,m]=l.useState(!1),[j,h]=l.useState(null),u=async()=>{if(!n){i({title:"Código requerido",description:"Por favor ingresa un código de sesión RON",variant:"destructive"});return}if(!/^RON-\d{4}-\d{3,}$/.test(n)){i({title:"Formato inválido",description:"El código debe tener el formato RON-YYYY-NNN (ej: RON-2025-001)",variant:"destructive"});return}m(!0),console.log("Verificando código RON:",n);try{const N=await fetch(`/api/ron/public/session/${n}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!N.ok)throw new Error("Código RON inválido o sesión no encontrada");const x=await N.json();if(!x.success)throw new Error(x.error||"Error al verificar el código de sesión");console.log("Sesión RON encontrada:",x),h(x),d(!0),i({title:"Sesión verificada",description:"Conectando a la sesión RON..."}),s(`/ron-client/${n}`,{replace:!0})}catch(N){console.error("Error al verificar sesión RON:",N),i({title:"Error al verificar sesión",description:N.message||"No se pudo verificar el código de sesión",variant:"destructive"})}finally{m(!1)}};l.useEffect(()=>{a.code&&!p&&!c&&(console.log("Código RON detectado en URL:",a.code),g(a.code),u())},[a.code,p,c]);const y=()=>{d(!1),h(null),s("/ron-platform",{replace:!0}),i({title:"Sesión finalizada",description:"Has salido de la sesión RON"})};return p&&j?e.jsxs("div",{className:"min-h-screen flex flex-col bg-slate-50 dark:bg-slate-900",children:[e.jsx("header",{className:"bg-white dark:bg-slate-800 shadow-sm py-4 px-6 border-b border-slate-200 dark:border-slate-700",children:e.jsx("div",{className:"flex items-center justify-between max-w-7xl mx-auto",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"h-6 w-6 text-indigo-600 dark:text-indigo-400"}),e.jsxs("h1",{className:"text-lg font-semibold text-slate-900 dark:text-white",children:["Sesión RON: ",n]}),e.jsxs("span",{className:"inline-flex items-center rounded-full bg-green-100 dark:bg-green-900 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:text-green-300",children:[e.jsx(le,{className:"h-3 w-3 mr-1"}),"Activa"]})]})})}),e.jsx("main",{className:"flex-1 container mx-auto px-4 py-6 max-w-7xl",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6",children:[e.jsx(K,{mode:"forced"}),e.jsxs(A,{className:"border-0 shadow-lg overflow-hidden",children:[e.jsxs(T,{className:"bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4",children:[e.jsxs(D,{className:"flex items-center",children:[e.jsx(S,{className:"h-5 w-5 mr-2"}),"Sesión de Certificación Remota"]}),e.jsx(L,{className:"text-indigo-100",children:"Verificación de identidad y firma electrónica en línea"})]}),e.jsx(F,{className:"p-0 h-[600px]",children:e.jsx(he,{sessionId:n,role:"client",onSessionEnd:y})})]}),e.jsxs(A,{children:[e.jsx(T,{children:e.jsxs(D,{className:"flex items-center",children:[e.jsx(de,{className:"h-5 w-5 mr-2 text-indigo-600"}),"Información de la sesión"]})}),e.jsx(F,{children:e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("div",{className:"font-medium",children:"Código de sesión:"}),e.jsx("div",{children:n}),e.jsx("div",{className:"font-medium",children:"Certificador:"}),e.jsx("div",{children:j.certifierName||"Certificador asignado"}),e.jsx("div",{className:"font-medium",children:"Propósito:"}),e.jsx("div",{children:j.purpose||"Firma de documentos"}),e.jsx("div",{className:"font-medium",children:"Estado:"}),e.jsx("div",{className:"text-green-600 font-medium",children:"Activo"})]})})}),e.jsx(U,{className:"border-t bg-slate-50 dark:bg-slate-800/50",children:e.jsxs("div",{className:"flex items-center text-sm text-slate-600 dark:text-slate-400",children:[e.jsx(me,{className:"h-4 w-4 mr-2 text-indigo-600"}),"La sesión permanecerá activa mientras no se cierre la ventana"]})})]})]})})]}):e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-indigo-50 to-white dark:from-slate-900 dark:to-slate-800 p-4",children:e.jsxs(A,{className:"w-full max-w-md shadow-xl border-0",children:[e.jsxs(T,{className:"bg-gradient-to-r from-indigo-500 to-purple-600 text-white",children:[e.jsxs(D,{className:"flex items-center justify-center",children:[e.jsx(S,{className:"h-6 w-6 mr-2"}),"Sesión RON"]}),e.jsx(L,{className:"text-center text-indigo-100",children:"Verificación de identidad y firma electrónica en línea"})]}),e.jsxs(F,{className:"pt-6",children:[e.jsx(K,{mode:"forced"}),e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"accessCode",className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Código de acceso RON"}),e.jsx(ue,{id:"accessCode",type:"text",placeholder:"Formato: RON-2025-001",value:n,onChange:C=>g(C.target.value),className:"w-full"}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"Ingresa el código proporcionado por tu certificador notarial"})]}),e.jsx(v,{className:"w-full bg-indigo-600 hover:bg-indigo-700",onClick:u,disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Verificando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Ingresar a la sesión"]})})]})]}),e.jsx(U,{className:"flex justify-center border-t bg-slate-50 dark:bg-slate-800/50",children:e.jsx("div",{className:"text-xs text-center text-slate-500 dark:text-slate-400 max-w-xs",children:"Esta plataforma cumple con la Ley 19.799 sobre documentos electrónicos y firma electrónica en Chile."})})]})})}export{je as default};
