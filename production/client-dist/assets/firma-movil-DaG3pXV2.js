import{r as i,bK as H,u as B,j as e,d,v as m,x,z as p,e as h,bN as y,bB as C,V as v,a as t,c as R,ax as j,i as D,az as u,aA as f,b5 as O,ad as Q,bW as F,aj as J,aB as I}from"./index-BPC64rrb.js";function G(){const[g,c]=i.useState(!0),[k,N]=i.useState(null),[s,T]=i.useState(null),[K,z]=i.useState(!1),[A,L]=i.useState(!1),[l,n]=i.useState("loading"),[P,M]=i.useState(null),E=H(),o=E.documentId,b=E.verificationCode,{toast:S}=B();i.useEffect(()=>{(async()=>{try{if(c(!0),N(null),!o||!b)throw new Error("Faltan parámetros necesarios para la verificación");const r=await fetch(`/api/qr-signature/document-info/${o}/${b}`);if(!r.ok)throw r.status===404?new Error("Documento no encontrado o código de verificación inválido"):new Error(`Error al cargar información (${r.status}): ${await r.text()}`);const w=await r.json();if(!w.success||!w.isValid)throw new Error("Código de verificación inválido o expirado");T(w.documentInfo),n("verificacion")}catch(r){console.error("Error al cargar información:",r),N(r.message||"Error desconocido al cargar información del documento"),n("error")}finally{c(!1)}})()},[o,b]);const V=()=>{n("confirmacion"),S({title:"Identidad confirmada",description:"Se ha verificado su identidad correctamente."})},$=async()=>{try{c(!0),await new Promise(r=>setTimeout(r,1500));const a={userId:Math.floor(Math.random()*1e3)+1,timestamp:new Date().toISOString(),ipAddress:"192.168.1."+Math.floor(Math.random()*255),signatureMethod:"mobile-qr"};M(a),n("firma")}catch(a){console.error("Error al generar firma:",a),N(a.message||"Error al generar la firma")}finally{c(!1)}},q=async()=>{try{c(!0);const a=await fetch("/api/qr-signature/sign",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({documentId:o,verificationCode:b,signatureData:P})});if(!a.ok)throw new Error(`Error al enviar firma (${a.status}): ${await a.text()}`);const r=await a.json();if(!r.success)throw new Error(r.error||"Error al procesar la firma");z(!0),n("completado"),S({title:"Firma completada",description:"El documento ha sido firmado exitosamente."})}catch(a){console.error("Error al enviar firma:",a),N(a.message||"Error al enviar la firma")}finally{c(!1)}};return l==="loading"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsxs(m,{className:"text-center",children:[e.jsx(x,{className:"text-2xl font-bold",children:"Cargando información"}),e.jsx(p,{children:"Por favor espere mientras verificamos el documento"})]}),e.jsx(h,{className:"flex justify-center py-8",children:e.jsx(y,{className:"h-16 w-16 animate-spin text-primary"})})]})}):l==="error"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsx(m,{className:"text-center bg-red-50",children:e.jsxs(x,{className:"text-xl font-bold text-red-700 flex items-center justify-center gap-2",children:[e.jsx(C,{className:"h-6 w-6"}),"Error de verificación"]})}),e.jsx(h,{className:"py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(C,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No se pudo verificar el documento"}),e.jsx("p",{className:"text-gray-600 mb-4",children:k||"Ha ocurrido un error al verificar el documento. El código QR puede ser inválido o haber expirado."})]})}),e.jsx(v,{className:"border-t pt-4 flex justify-center",children:e.jsx(t,{variant:"outline",onClick:()=>window.close(),children:"Cerrar"})})]})}):l==="verificacion"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsxs(m,{className:"border-b",children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-5 w-5"}),"Verificación de identidad"]}),e.jsx(p,{children:"Para continuar con la firma del documento"})]}),e.jsxs(h,{className:"py-6 space-y-4",children:[s&&e.jsxs(j,{className:"bg-blue-50 border-blue-200",children:[e.jsx(D,{className:"h-4 w-4 text-blue-800"}),e.jsx(u,{children:"Información del documento"}),e.jsxs(f,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Nombre:"})," ",s.title]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tipo:"})," ",s.type]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Cliente:"})," ",s.client.name]})]})]}),e.jsxs("div",{className:"rounded-lg border p-4",children:[e.jsx("h3",{className:"text-sm font-medium mb-3",children:"Verificar su identidad mediante:"}),e.jsx("div",{className:"space-y-2",children:e.jsxs(t,{variant:"outline",className:"w-full justify-start text-left h-auto py-3",onClick:V,children:[e.jsx("div",{className:"mr-2 h-5 w-5 flex items-center justify-center rounded-full bg-primary/10 text-primary",children:"1"}),e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"font-medium",children:"Cédula de identidad"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Verifique su identidad mediante su cédula"})]})]})})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-4",children:[e.jsx(O,{id:"aceptar-terminos",checked:A,onCheckedChange:L}),e.jsx(Q,{htmlFor:"aceptar-terminos",className:"text-sm text-gray-600",children:"Acepto los términos y condiciones de firma electrónica avanzada según Ley N° 19.799"})]})]})]})}):l==="confirmacion"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsxs(m,{className:"border-b",children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5"}),"Confirmar firma del documento"]}),e.jsx(p,{children:"Revise la información antes de firmar"})]}),e.jsx(h,{className:"py-6 space-y-4",children:s&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{className:"bg-blue-50 border-blue-200",children:[e.jsx(D,{className:"h-4 w-4 text-blue-800"}),e.jsx(u,{children:"Documento a firmar"}),e.jsxs(f,{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Nombre:"})," ",s.title]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Tipo:"})," ",s.type]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," ",new Date(s.createdAt).toLocaleDateString()]})]})]}),e.jsxs(j,{children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(u,{children:"Información importante"}),e.jsx(f,{children:e.jsx("p",{className:"text-sm",children:"Al firmar este documento, usted está utilizando firma electrónica avanzada de acuerdo con la Ley N° 19.799. Esta firma tiene la misma validez legal que una firma manuscrita."})})]})]})}),e.jsxs(v,{className:"border-t pt-4 flex justify-between",children:[e.jsx(t,{variant:"outline",onClick:()=>n("verificacion"),children:"Volver"}),e.jsx(t,{onClick:$,disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"}),"Procesando..."]}):"Firmar documento"})]})]})}):l==="firma"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsxs(m,{className:"border-b",children:[e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5"}),"Firma en proceso"]}),e.jsx(p,{children:"Confirme para finalizar el proceso"})]}),e.jsxs(h,{className:"py-6 space-y-4",children:[e.jsxs(j,{className:"bg-blue-50 border-blue-200",children:[e.jsx(u,{children:"Firma generada correctamente"}),e.jsxs(f,{children:[e.jsx("p",{children:"Se ha generado una firma electrónica avanzada para su documento."}),e.jsx("p",{className:"mt-2",children:'Haga clic en "Completar firma" para finalizar el proceso.'})]})]}),e.jsxs("div",{className:"rounded-lg border p-4 bg-gray-50",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"Datos de la firma:"}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"ID de documento:"})," ",o]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha y hora:"})," ",new Date().toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Método de firma:"})," Firma móvil QR"]})]})]})]}),e.jsxs(v,{className:"border-t pt-4 flex justify-between",children:[e.jsx(t,{variant:"outline",onClick:()=>n("confirmacion"),children:"Volver"}),e.jsx(t,{onClick:q,disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"}),"Enviando..."]}):"Completar firma"})]})]})}):l==="completado"?e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(d,{children:[e.jsxs(m,{className:"bg-green-50 border-b",children:[e.jsxs(x,{className:"flex items-center gap-2 text-green-700",children:[e.jsx(I,{className:"h-5 w-5"}),"Firma completada"]}),e.jsx(p,{children:"El documento ha sido firmado correctamente"})]}),e.jsx(h,{className:"pt-6 pb-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(I,{className:"h-16 w-16 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"¡Firma exitosa!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"El documento ha sido firmado electrónicamente de manera exitosa."}),e.jsxs(j,{className:"mb-4 text-left",children:[e.jsx(u,{children:"Información de la firma"}),e.jsxs(f,{children:[e.jsx("p",{children:"Se ha utilizado firma electrónica avanzada según Ley 19.799."}),s&&e.jsxs("p",{className:"mt-2",children:["Documento firmado: ",e.jsx("strong",{children:s.title})]}),e.jsxs("p",{className:"mt-2",children:["ID de documento: ",e.jsx("strong",{children:o})]}),e.jsxs("p",{className:"mt-2",children:["Hora de firma: ",e.jsx("strong",{children:new Date().toLocaleString()})]})]})]})]})}),e.jsx(v,{className:"border-t pt-4 flex justify-center",children:e.jsx(t,{onClick:()=>window.close(),children:"Cerrar"})})]})}):e.jsx("div",{className:"container max-w-md mx-auto px-4 py-8",children:e.jsxs(j,{variant:"destructive",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx(u,{children:"Error inesperado"}),e.jsx(f,{children:"Ha ocurrido un error inesperado en la aplicación. Por favor, intente nuevamente más tarde."})]})})}export{G as default};
